<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Entanglement - Spooky Action at a Distance</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@300;400;500;600&family=Space+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #020617;
            --bg-card: rgba(15, 23, 42, 0.85);
            --accent-cyan: #00f3ff;
            --accent-magenta: #ff0080;
            --accent-gold: #ffd700;
            --accent-purple: #a855f7;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --text-bright: #f0f0f0;
            --text-dim: #94a3b8;
            --border-glow: rgba(0, 243, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background: var(--bg-deep);
            color: var(--text-bright);
        }

        #mainCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.7) 100%);
            pointer-events: none;
            z-index: 2;
        }

        .ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .ui-panel {
            pointer-events: auto;
            position: absolute;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-glow);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.1), inset 0 1px 0 rgba(255,255,255,0.05);
        }

        .header-panel {
            top: 20px;
            left: 20px;
            max-width: 420px;
        }

        .sector-label {
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--accent-purple);
            margin-bottom: 8px;
        }

        .title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 0.85rem;
            color: var(--text-dim);
            line-height: 1.5;
        }

        /* Controls Panel */
        .controls-panel {
            top: 20px;
            right: 20px;
            width: 300px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .control-name {
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--accent-cyan);
        }

        .control-value {
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            color: var(--accent-gold);
        }

        .slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-magenta));
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 15px var(--accent-purple);
        }

        /* Statistics Panel */
        .stats-panel {
            bottom: 20px;
            right: 20px;
            width: 320px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            color: var(--accent-cyan);
        }

        .stat-value.violation {
            color: var(--accent-magenta);
            font-weight: bold;
        }

        .bell-result {
            text-align: center;
            padding: 15px;
            margin-top: 10px;
            border-radius: 10px;
            font-family: 'Orbitron', sans-serif;
        }

        .bell-result.quantum {
            background: rgba(168, 85, 247, 0.2);
            border: 1px solid var(--accent-purple);
        }

        .bell-result.classical {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--accent-red);
        }

        /* Equation Panel */
        .equation-panel {
            bottom: 20px;
            left: 20px;
            max-width: 480px;
        }

        .equation-title {
            font-size: 0.7rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--accent-magenta);
            margin-bottom: 12px;
        }

        .equation {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
            color: var(--text-bright);
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
        }

        .equation .highlight { color: var(--accent-gold); }
        .equation .cyan { color: var(--accent-cyan); }
        .equation .magenta { color: var(--accent-magenta); }
        .equation .purple { color: var(--accent-purple); }

        .equation-explanation {
            font-size: 0.8rem;
            color: var(--text-dim);
            line-height: 1.6;
        }

        /* Detector Labels */
        .detector-panel {
            width: 200px;
            text-align: center;
        }

        .detector-left {
            top: 50%;
            left: 80px;
            transform: translateY(-50%);
        }

        .detector-right {
            top: 50%;
            right: 80px;
            transform: translateY(-50%);
        }

        .detector-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            color: var(--accent-cyan);
            margin-bottom: 10px;
        }

        .detector-angle {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            color: var(--accent-gold);
            margin-bottom: 10px;
        }

        .detector-result {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .detector-count {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        /* Mode buttons */
        .mode-panel {
            top: 180px;
            left: 20px;
        }

        .mode-btn {
            display: block;
            width: 100%;
            padding: 10px 16px;
            margin-bottom: 8px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text-dim);
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .mode-btn:hover {
            background: rgba(168, 85, 247, 0.1);
            border-color: var(--accent-purple);
        }

        .mode-btn.active {
            background: rgba(168, 85, 247, 0.2);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        /* Action Buttons */
        .action-panel {
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }

        .action-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-magenta));
            border: none;
            border-radius: 30px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            color: white;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.4);
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px rgba(168, 85, 247, 0.6);
        }

        .action-btn.secondary {
            background: rgba(255,255,255,0.1);
            box-shadow: none;
        }

        .action-btn.secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Info Panel */
        .info-panel {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 500px;
            text-align: center;
            pointer-events: none;
        }

        .info-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-purple);
            margin-bottom: 15px;
        }

        .info-text {
            font-size: 0.9rem;
            color: var(--text-dim);
            line-height: 1.7;
        }

        .info-text strong {
            color: var(--accent-gold);
        }

        /* Intro Overlay */
        .intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(2, 6, 23, 0.98);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 1s ease;
        }

        .intro-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .intro-content {
            max-width: 750px;
            text-align: center;
            padding: 40px;
        }

        .intro-eyebrow {
            font-size: 0.75rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--accent-purple);
            margin-bottom: 20px;
        }

        .intro-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-magenta), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .intro-quote {
            font-size: 1.2rem;
            font-style: italic;
            color: var(--text-dim);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .intro-quote cite {
            display: block;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--accent-gold);
            font-style: normal;
        }

        .intro-text {
            font-size: 1rem;
            color: var(--text-dim);
            line-height: 1.8;
            margin-bottom: 40px;
        }

        .intro-btn {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-magenta));
            border: none;
            border-radius: 30px;
            padding: 15px 40px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.4);
            transition: all 0.3s ease;
        }

        .intro-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 60px rgba(168, 85, 247, 0.6);
        }

        /* Correlation meter */
        .correlation-panel {
            top: 180px;
            right: 20px;
            width: 300px;
        }

        .correlation-bar {
            height: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
        }

        .correlation-fill {
            height: 100%;
            border-radius: 15px;
            transition: width 0.3s ease;
        }

        .correlation-fill.quantum {
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-magenta));
        }

        .correlation-fill.classical {
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
        }

        .correlation-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .bell-limit {
            position: absolute;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--accent-gold);
            box-shadow: 0 0 10px var(--accent-gold);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        @keyframes entangle {
            0% { stroke-dashoffset: 1000; }
            100% { stroke-dashoffset: 0; }
        }
    </style>
</head>
<body>

<canvas id="mainCanvas"></canvas>
<div class="vignette"></div>

<!-- Intro Overlay -->
<div class="intro-overlay" id="introOverlay">
    <div class="intro-content">
        <div class="intro-eyebrow">Sector 08 · Quantum Mechanics</div>
        <h1 class="intro-title">Quantum Entanglement</h1>
        <p class="intro-quote">
            "I cannot seriously believe in [quantum mechanics] because... physics should represent a reality in time and space, free from spooky actions at a distance."
            <cite>— Albert Einstein, 1947</cite>
        </p>
        <p class="intro-text">
            Einstein was wrong. In 1964, physicist John Bell devised a test that could prove whether quantum mechanics was truly "spooky" or if there were hidden variables we couldn't see. Experiments have now confirmed: <strong>measuring one particle instantly affects its entangled partner</strong>, no matter how far apart they are.<br><br>
            This isn't science fiction. It's been verified across cities, between islands, and even from Earth to satellites in space. The universe is stranger than Einstein dared imagine.
        </p>
        <button class="intro-btn" onclick="startExperience()">WITNESS THE SPOOKINESS</button>
    </div>
</div>

<!-- UI Layer -->
<div class="ui-layer" id="uiLayer" style="opacity: 0; transition: opacity 1s ease;">

    <!-- Header -->
    <div class="ui-panel header-panel">
        <div class="sector-label">Sector 08 · Quantum Foundations</div>
        <h1 class="title">Quantum Entanglement</h1>
        <p class="subtitle">Create entangled particle pairs and watch correlations that defy classical physics. Bell's inequality proves this isn't hidden variables—it's genuine quantum weirdness.</p>
    </div>

    <!-- Mode Selection -->
    <div class="ui-panel mode-panel">
        <button class="mode-btn active" id="modeEPR" onclick="setMode('epr')">EPR Experiment</button>
        <button class="mode-btn" id="modeBell" onclick="setMode('bell')">Bell Test</button>
        <button class="mode-btn" id="modeCorrelation" onclick="setMode('correlation')">Correlation Graph</button>
    </div>

    <!-- Controls -->
    <div class="ui-panel controls-panel">
        <div class="control-group">
            <div class="control-label">
                <span class="control-name">Detector A Angle</span>
                <span class="control-value" id="angleADisplay">0°</span>
            </div>
            <input type="range" class="slider" id="angleASlider" min="0" max="360" step="1" value="0">
        </div>
        <div class="control-group">
            <div class="control-label">
                <span class="control-name">Detector B Angle</span>
                <span class="control-value" id="angleBDisplay">0°</span>
            </div>
            <input type="range" class="slider" id="angleBSlider" min="0" max="360" step="1" value="0">
        </div>
        <div class="control-group">
            <div class="control-label">
                <span class="control-name">Pair Separation</span>
                <span class="control-value" id="separationDisplay">1 km</span>
            </div>
            <input type="range" class="slider" id="separationSlider" min="1" max="1000" step="1" value="1">
        </div>
    </div>

    <!-- Correlation Panel -->
    <div class="ui-panel correlation-panel" id="correlationPanel">
        <div class="equation-title">Bell Inequality Test</div>
        <div class="correlation-bar">
            <div class="correlation-fill quantum" id="correlationFill" style="width: 0%"></div>
            <div class="bell-limit" id="bellLimit" style="left: 70.7%"></div>
        </div>
        <div class="correlation-labels">
            <span>0%</span>
            <span style="color: var(--accent-gold);">Bell Limit (2)</span>
            <span>100% (2√2)</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">S Value (CHSH)</span>
            <span class="stat-value" id="sValue">0.00</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Classical Max</span>
            <span class="stat-value">2.00</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Quantum Max</span>
            <span class="stat-value" style="color: var(--accent-magenta)">2.83 (2√2)</span>
        </div>
    </div>

    <!-- Left Detector -->
    <div class="ui-panel detector-panel detector-left" id="detectorA">
        <div class="detector-name">DETECTOR A</div>
        <div class="detector-angle" id="detectorAAngle">0°</div>
        <div class="detector-result" id="detectorAResult">—</div>
        <div class="detector-count">
            <span id="detectorAUp">↑ 0</span> | <span id="detectorADown">↓ 0</span>
        </div>
    </div>

    <!-- Right Detector -->
    <div class="ui-panel detector-panel detector-right" id="detectorB">
        <div class="detector-name">DETECTOR B</div>
        <div class="detector-angle" id="detectorBAngle">0°</div>
        <div class="detector-result" id="detectorBResult">—</div>
        <div class="detector-count">
            <span id="detectorBUp">↑ 0</span> | <span id="detectorBDown">↓ 0</span>
        </div>
    </div>

    <!-- Statistics Panel -->
    <div class="ui-panel stats-panel">
        <div class="equation-title">Measurement Statistics</div>
        <div class="stat-row">
            <span class="stat-label">Total Pairs Measured</span>
            <span class="stat-value" id="totalPairs">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Correlated (Same)</span>
            <span class="stat-value" id="sameCount">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Anti-Correlated (Opposite)</span>
            <span class="stat-value" id="oppositeCount">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Correlation Coefficient</span>
            <span class="stat-value" id="correlationCoeff">0.00</span>
        </div>
        <div class="bell-result quantum" id="bellResult">
            <div style="font-size: 0.7rem; margin-bottom: 5px;">PREDICTION</div>
            <div id="bellPrediction">Run experiment to see results</div>
        </div>
    </div>

    <!-- Equation Panel -->
    <div class="ui-panel equation-panel">
        <div class="equation-title">Bell's Inequality (CHSH Form)</div>
        <div class="equation">
            <span class="purple">S</span> = |<span class="cyan">E(a,b)</span> - <span class="cyan">E(a,b')</span>| + |<span class="cyan">E(a',b)</span> + <span class="cyan">E(a',b')</span>|
        </div>
        <div class="equation">
            Classical: <span class="highlight">S ≤ 2</span> &nbsp;&nbsp; Quantum: <span class="magenta">S ≤ 2√2 ≈ 2.83</span>
        </div>
        <div class="equation-explanation">
            If hidden variables existed, S could never exceed 2. Quantum mechanics predicts—and experiments confirm—values up to 2√2. <strong>Reality is non-local.</strong>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-panel">
        <button class="action-btn" onclick="createEntangledPair()">CREATE ENTANGLED PAIR</button>
        <button class="action-btn secondary" onclick="runBellTest()">RUN BELL TEST (100 pairs)</button>
        <button class="action-btn secondary" onclick="resetStats()">RESET</button>
    </div>

</div>

<script>
// ============================================
// QUANTUM ENTANGLEMENT VISUALIZATION
// Spooky Action at a Distance
// ============================================

const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');

// === STATE ===
const STATE = {
    mode: 'epr',
    angleA: 0,          // Detector A angle in degrees
    angleB: 0,          // Detector B angle in degrees
    separation: 1,      // km
    particles: [],
    entangledPairs: [],
    measurements: [],
    stats: {
        total: 0,
        same: 0,
        opposite: 0,
        aUp: 0,
        aDown: 0,
        bUp: 0,
        bDown: 0
    },
    bellTestResults: [],
    stars: [],
    time: 0
};

// === COLORS ===
const COLORS = {
    cyan: '#00f3ff',
    magenta: '#ff0080',
    gold: '#ffd700',
    purple: '#a855f7',
    blue: '#3b82f6',
    green: '#22c55e',
    red: '#ef4444',
    white: '#ffffff',
    dim: 'rgba(255, 255, 255, 0.3)'
};

// === INITIALIZATION ===
function init() {
    resize();
    window.addEventListener('resize', resize);

    // Generate stars
    for (let i = 0; i < 200; i++) {
        STATE.stars.push({
            x: Math.random(),
            y: Math.random(),
            size: Math.random() * 1.5 + 0.5,
            twinkle: Math.random() * Math.PI * 2
        });
    }

    setupControls();
    requestAnimationFrame(loop);
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

function setupControls() {
    document.getElementById('angleASlider').addEventListener('input', (e) => {
        STATE.angleA = parseInt(e.target.value);
        updateDisplays();
    });

    document.getElementById('angleBSlider').addEventListener('input', (e) => {
        STATE.angleB = parseInt(e.target.value);
        updateDisplays();
    });

    document.getElementById('separationSlider').addEventListener('input', (e) => {
        STATE.separation = parseInt(e.target.value);
        updateDisplays();
    });
}

function updateDisplays() {
    document.getElementById('angleADisplay').textContent = STATE.angleA + '°';
    document.getElementById('angleBDisplay').textContent = STATE.angleB + '°';
    document.getElementById('detectorAAngle').textContent = STATE.angleA + '°';
    document.getElementById('detectorBAngle').textContent = STATE.angleB + '°';
    document.getElementById('separationDisplay').textContent = STATE.separation + ' km';

    // Update correlation prediction
    updateCorrelationPrediction();
}

function updateCorrelationPrediction() {
    // Quantum prediction for correlation
    const angleDiff = (STATE.angleB - STATE.angleA) * Math.PI / 180;
    const quantumCorrelation = -Math.cos(angleDiff);

    // For Bell test S value with optimal angles
    // S = 2√2 when angles are 0, 45, 22.5, 67.5 degrees
    const sValue = calculateSValue();

    document.getElementById('sValue').textContent = sValue.toFixed(2);

    // Color the S value based on whether it violates Bell inequality
    const sValueEl = document.getElementById('sValue');
    if (sValue > 2) {
        sValueEl.classList.add('violation');
    } else {
        sValueEl.classList.remove('violation');
    }

    // Update correlation bar
    const maxS = 2 * Math.sqrt(2);
    const percentage = (sValue / maxS) * 100;
    document.getElementById('correlationFill').style.width = percentage + '%';
}

function calculateSValue() {
    // CHSH inequality with current angles
    // Using standard Bell test angles: a=0, a'=45, b=22.5, b'=67.5
    const a = 0;
    const aPrime = 45;
    const b = 22.5;
    const bPrime = 67.5;

    const E_ab = -Math.cos((b - a) * Math.PI / 180);
    const E_abPrime = -Math.cos((bPrime - a) * Math.PI / 180);
    const E_aPrimeb = -Math.cos((b - aPrime) * Math.PI / 180);
    const E_aPrimebPrime = -Math.cos((bPrime - aPrime) * Math.PI / 180);

    return Math.abs(E_ab - E_abPrime) + Math.abs(E_aPrimeb + E_aPrimebPrime);
}

// === ENTANGLEMENT PHYSICS ===
function createEntangledPair() {
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;

    // Create source flash
    STATE.particles.push({
        type: 'flash',
        x: cx,
        y: cy,
        radius: 5,
        maxRadius: 100,
        alpha: 1,
        color: COLORS.purple
    });

    // Create entangled pair
    // The "hidden" spin orientation (for visualization)
    const spinOrientation = Math.random() * 360;

    const pair = {
        id: Date.now(),
        spinOrientation: spinOrientation,
        particleA: {
            x: cx,
            y: cy,
            targetX: 200,
            targetY: cy,
            vx: -8,
            vy: 0,
            measured: false,
            result: null,
            color: COLORS.cyan
        },
        particleB: {
            x: cx,
            y: cy,
            targetX: canvas.width - 200,
            targetY: cy,
            vx: 8,
            vy: 0,
            measured: false,
            result: null,
            color: COLORS.magenta
        },
        entanglementLine: true,
        measured: false
    };

    STATE.entangledPairs.push(pair);
}

function measureParticle(pair, detector) {
    if (pair.measured) return;

    const angle = detector === 'A' ? STATE.angleA : STATE.angleB;
    const particle = detector === 'A' ? pair.particleA : pair.particleB;

    // Quantum measurement
    // Probability of spin up along detector axis
    const angleDiff = (angle - pair.spinOrientation) * Math.PI / 180;
    const probUp = Math.cos(angleDiff / 2) ** 2;

    const result = Math.random() < probUp ? 'up' : 'down';
    particle.result = result;
    particle.measured = true;

    // Create measurement flash
    STATE.particles.push({
        type: 'measurement',
        x: particle.x,
        y: particle.y,
        radius: 5,
        maxRadius: 60,
        alpha: 1,
        color: result === 'up' ? COLORS.green : COLORS.red
    });

    // Update display
    if (detector === 'A') {
        document.getElementById('detectorAResult').textContent = result === 'up' ? '↑' : '↓';
        document.getElementById('detectorAResult').style.color = result === 'up' ? COLORS.green : COLORS.red;
    } else {
        document.getElementById('detectorBResult').textContent = result === 'up' ? '↑' : '↓';
        document.getElementById('detectorBResult').style.color = result === 'up' ? COLORS.green : COLORS.red;
    }

    return result;
}

function checkMeasurements() {
    STATE.entangledPairs.forEach(pair => {
        if (pair.measured) return;

        // Check if particles reached detectors
        const aAtDetector = pair.particleA.x <= 200;
        const bAtDetector = pair.particleB.x >= canvas.width - 200;

        if (aAtDetector && !pair.particleA.measured) {
            measureParticle(pair, 'A');
        }

        if (bAtDetector && !pair.particleB.measured) {
            measureParticle(pair, 'B');
        }

        // Both measured - record correlation
        if (pair.particleA.measured && pair.particleB.measured && !pair.measured) {
            pair.measured = true;
            pair.entanglementLine = false;

            const resultA = pair.particleA.result;
            const resultB = pair.particleB.result;

            STATE.stats.total++;
            if (resultA === resultB) {
                STATE.stats.same++;
            } else {
                STATE.stats.opposite++;
            }

            if (resultA === 'up') STATE.stats.aUp++;
            else STATE.stats.aDown++;

            if (resultB === 'up') STATE.stats.bUp++;
            else STATE.stats.bDown++;

            updateStats();
        }
    });

    // Clean up old pairs
    STATE.entangledPairs = STATE.entangledPairs.filter(pair => {
        if (pair.measured) {
            return Date.now() - pair.id < 3000; // Keep for 3 seconds
        }
        return true;
    });
}

function updateStats() {
    document.getElementById('totalPairs').textContent = STATE.stats.total;
    document.getElementById('sameCount').textContent = STATE.stats.same;
    document.getElementById('oppositeCount').textContent = STATE.stats.opposite;
    document.getElementById('detectorAUp').textContent = '↑ ' + STATE.stats.aUp;
    document.getElementById('detectorADown').textContent = '↓ ' + STATE.stats.aDown;
    document.getElementById('detectorBUp').textContent = '↑ ' + STATE.stats.bUp;
    document.getElementById('detectorBDown').textContent = '↓ ' + STATE.stats.bDown;

    // Calculate correlation coefficient
    if (STATE.stats.total > 0) {
        const correlation = (STATE.stats.same - STATE.stats.opposite) / STATE.stats.total;
        document.getElementById('correlationCoeff').textContent = correlation.toFixed(3);

        // Update Bell prediction
        const angleDiff = Math.abs(STATE.angleB - STATE.angleA);
        const quantumPrediction = -Math.cos(angleDiff * Math.PI / 180);

        const bellResult = document.getElementById('bellResult');
        const bellPrediction = document.getElementById('bellPrediction');

        if (STATE.stats.total >= 10) {
            const expectedClassical = angleDiff <= 90 ?
                -1 + (2 * angleDiff / 90) :
                1 - (2 * (angleDiff - 90) / 90);

            if (Math.abs(correlation - quantumPrediction) < Math.abs(correlation - expectedClassical)) {
                bellResult.className = 'bell-result quantum';
                bellPrediction.innerHTML = 'Results match <strong>QUANTUM</strong> prediction!<br>Correlation: ' + correlation.toFixed(3);
            } else {
                bellResult.className = 'bell-result classical';
                bellPrediction.textContent = 'Insufficient data for Bell violation';
            }
        }
    }
}

function runBellTest() {
    // Run 100 measurements with optimal Bell test angles
    const testAngles = [
        { a: 0, b: 22.5 },
        { a: 0, b: 67.5 },
        { a: 45, b: 22.5 },
        { a: 45, b: 67.5 }
    ];

    let results = { ab: [], abPrime: [], aPrimeb: [], aPrimebPrime: [] };

    for (let i = 0; i < 100; i++) {
        const spinOrientation = Math.random() * 360;

        testAngles.forEach((angles, idx) => {
            const diffA = (angles.a - spinOrientation) * Math.PI / 180;
            const diffB = (angles.b - spinOrientation) * Math.PI / 180;

            const probUpA = Math.cos(diffA / 2) ** 2;
            const probUpB = Math.cos(diffB / 2) ** 2;

            const resultA = Math.random() < probUpA ? 1 : -1;
            const resultB = Math.random() < probUpB ? 1 : -1;

            const correlation = resultA * resultB;

            if (idx === 0) results.ab.push(correlation);
            else if (idx === 1) results.abPrime.push(correlation);
            else if (idx === 2) results.aPrimeb.push(correlation);
            else results.aPrimebPrime.push(correlation);
        });
    }

    // Calculate S value
    const E_ab = results.ab.reduce((a, b) => a + b, 0) / results.ab.length;
    const E_abPrime = results.abPrime.reduce((a, b) => a + b, 0) / results.abPrime.length;
    const E_aPrimeb = results.aPrimeb.reduce((a, b) => a + b, 0) / results.aPrimeb.length;
    const E_aPrimebPrime = results.aPrimebPrime.reduce((a, b) => a + b, 0) / results.aPrimebPrime.length;

    const S = Math.abs(E_ab - E_abPrime) + Math.abs(E_aPrimeb + E_aPrimebPrime);

    document.getElementById('sValue').textContent = S.toFixed(3);

    const sValueEl = document.getElementById('sValue');
    if (S > 2) {
        sValueEl.classList.add('violation');
        document.getElementById('bellResult').className = 'bell-result quantum';
        document.getElementById('bellPrediction').innerHTML =
            '<strong>BELL INEQUALITY VIOLATED!</strong><br>S = ' + S.toFixed(3) + ' > 2<br>Hidden variables RULED OUT';
    } else {
        sValueEl.classList.remove('violation');
    }

    // Update correlation bar
    const maxS = 2 * Math.sqrt(2);
    document.getElementById('correlationFill').style.width = (S / maxS * 100) + '%';

    // Visual effect
    for (let i = 0; i < 20; i++) {
        setTimeout(() => createEntangledPair(), i * 50);
    }
}

function resetStats() {
    STATE.stats = {
        total: 0,
        same: 0,
        opposite: 0,
        aUp: 0,
        aDown: 0,
        bUp: 0,
        bDown: 0
    };
    STATE.entangledPairs = [];
    STATE.particles = [];

    document.getElementById('detectorAResult').textContent = '—';
    document.getElementById('detectorBResult').textContent = '—';
    document.getElementById('detectorAResult').style.color = COLORS.white;
    document.getElementById('detectorBResult').style.color = COLORS.white;

    updateStats();
    document.getElementById('bellPrediction').textContent = 'Run experiment to see results';
    document.getElementById('bellResult').className = 'bell-result quantum';
}

function setMode(mode) {
    STATE.mode = mode;
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('mode' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
}

function startExperience() {
    document.getElementById('introOverlay').classList.add('hidden');
    document.getElementById('uiLayer').style.opacity = '1';
}

// === MAIN LOOP ===
function loop(timestamp) {
    STATE.time = timestamp / 1000;
    update();
    draw();
    requestAnimationFrame(loop);
}

function update() {
    // Update particles
    STATE.particles = STATE.particles.filter(p => {
        if (p.type === 'flash' || p.type === 'measurement') {
            p.radius += 3;
            p.alpha -= 0.03;
            return p.alpha > 0;
        }
        return true;
    });

    // Update entangled pairs
    STATE.entangledPairs.forEach(pair => {
        if (!pair.particleA.measured) {
            pair.particleA.x += pair.particleA.vx;
        }
        if (!pair.particleB.measured) {
            pair.particleB.x += pair.particleB.vx;
        }
    });

    checkMeasurements();
}

function draw() {
    // Clear
    ctx.fillStyle = '#020617';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Stars
    STATE.stars.forEach(star => {
        const twinkle = Math.sin(STATE.time * 2 + star.twinkle) * 0.3 + 0.7;
        ctx.fillStyle = `rgba(255, 255, 255, ${twinkle * 0.6})`;
        ctx.beginPath();
        ctx.arc(star.x * canvas.width, star.y * canvas.height, star.size, 0, Math.PI * 2);
        ctx.fill();
    });

    const cx = canvas.width / 2;
    const cy = canvas.height / 2;

    // Draw source
    drawSource(cx, cy);

    // Draw detectors
    drawDetector(200, cy, STATE.angleA, 'A');
    drawDetector(canvas.width - 200, cy, STATE.angleB, 'B');

    // Draw entangled pairs
    STATE.entangledPairs.forEach(pair => {
        drawEntangledPair(pair);
    });

    // Draw particle effects
    STATE.particles.forEach(p => {
        if (p.type === 'flash' || p.type === 'measurement') {
            ctx.globalAlpha = p.alpha;
            const gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.radius);
            gradient.addColorStop(0, p.color);
            gradient.addColorStop(1, 'transparent');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;
        }
    });

    // Draw separation indicator
    drawSeparation();
}

function drawSource(x, y) {
    // Glowing source
    const gradient = ctx.createRadialGradient(x, y, 0, x, y, 60);
    gradient.addColorStop(0, 'rgba(168, 85, 247, 0.8)');
    gradient.addColorStop(0.3, 'rgba(168, 85, 247, 0.3)');
    gradient.addColorStop(1, 'transparent');
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(x, y, 60, 0, Math.PI * 2);
    ctx.fill();

    // Core
    ctx.fillStyle = COLORS.purple;
    ctx.beginPath();
    ctx.arc(x, y, 15, 0, Math.PI * 2);
    ctx.fill();

    // Pulsing ring
    const pulseRadius = 30 + Math.sin(STATE.time * 3) * 10;
    ctx.strokeStyle = `rgba(168, 85, 247, ${0.5 + Math.sin(STATE.time * 3) * 0.3})`;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(x, y, pulseRadius, 0, Math.PI * 2);
    ctx.stroke();

    // Label
    ctx.fillStyle = COLORS.purple;
    ctx.font = '12px Orbitron';
    ctx.textAlign = 'center';
    ctx.fillText('ENTANGLEMENT SOURCE', x, y + 80);
}

function drawDetector(x, y, angle, label) {
    const radius = 50;

    // Detector housing
    ctx.strokeStyle = label === 'A' ? COLORS.cyan : COLORS.magenta;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.stroke();

    // Detector glow
    const gradient = ctx.createRadialGradient(x, y, radius * 0.5, x, y, radius * 1.5);
    gradient.addColorStop(0, label === 'A' ? 'rgba(0, 243, 255, 0.2)' : 'rgba(255, 0, 128, 0.2)');
    gradient.addColorStop(1, 'transparent');
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(x, y, radius * 1.5, 0, Math.PI * 2);
    ctx.fill();

    // Polarizer angle indicator
    const angleRad = angle * Math.PI / 180;
    ctx.strokeStyle = COLORS.gold;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x - Math.cos(angleRad) * radius * 0.7, y - Math.sin(angleRad) * radius * 0.7);
    ctx.lineTo(x + Math.cos(angleRad) * radius * 0.7, y + Math.sin(angleRad) * radius * 0.7);
    ctx.stroke();

    // Angle arrow
    const arrowLen = radius * 0.7;
    const arrowX = x + Math.cos(angleRad) * arrowLen;
    const arrowY = y + Math.sin(angleRad) * arrowLen;
    ctx.fillStyle = COLORS.gold;
    ctx.beginPath();
    ctx.arc(arrowX, arrowY, 5, 0, Math.PI * 2);
    ctx.fill();
}

function drawEntangledPair(pair) {
    const pA = pair.particleA;
    const pB = pair.particleB;

    // Entanglement connection line
    if (pair.entanglementLine) {
        ctx.strokeStyle = 'rgba(168, 85, 247, 0.3)';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 10]);
        ctx.beginPath();
        ctx.moveTo(pA.x, pA.y);
        ctx.lineTo(pB.x, pB.y);
        ctx.stroke();
        ctx.setLineDash([]);

        // Traveling wave effect on entanglement line
        const wavePoints = 20;
        const amplitude = 5;
        ctx.strokeStyle = 'rgba(168, 85, 247, 0.6)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for (let i = 0; i <= wavePoints; i++) {
            const t = i / wavePoints;
            const x = pA.x + (pB.x - pA.x) * t;
            const baseY = pA.y + (pB.y - pA.y) * t;
            const wave = Math.sin(t * 10 + STATE.time * 5) * amplitude;
            if (i === 0) ctx.moveTo(x, baseY + wave);
            else ctx.lineTo(x, baseY + wave);
        }
        ctx.stroke();
    }

    // Particle A
    drawParticle(pA.x, pA.y, pA.color, pA.measured, pA.result);

    // Particle B
    drawParticle(pB.x, pB.y, pB.color, pB.measured, pB.result);
}

function drawParticle(x, y, color, measured, result) {
    // Glow
    const gradient = ctx.createRadialGradient(x, y, 0, x, y, 25);
    gradient.addColorStop(0, color);
    gradient.addColorStop(0.5, color + '40');
    gradient.addColorStop(1, 'transparent');
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(x, y, 25, 0, Math.PI * 2);
    ctx.fill();

    // Core
    ctx.fillStyle = measured ? (result === 'up' ? COLORS.green : COLORS.red) : COLORS.white;
    ctx.beginPath();
    ctx.arc(x, y, 8, 0, Math.PI * 2);
    ctx.fill();

    // Spin arrow if measured
    if (measured) {
        ctx.strokeStyle = COLORS.white;
        ctx.lineWidth = 2;
        const arrowY = result === 'up' ? -15 : 15;
        ctx.beginPath();
        ctx.moveTo(x, y + arrowY);
        ctx.lineTo(x, y - arrowY);
        ctx.stroke();

        // Arrow head
        const headY = y - arrowY;
        const headDir = result === 'up' ? -1 : 1;
        ctx.beginPath();
        ctx.moveTo(x, headY);
        ctx.lineTo(x - 5, headY + headDir * 8);
        ctx.moveTo(x, headY);
        ctx.lineTo(x + 5, headY + headDir * 8);
        ctx.stroke();
    }
}

function drawSeparation() {
    const leftX = 200;
    const rightX = canvas.width - 200;
    const y = canvas.height - 100;

    ctx.strokeStyle = COLORS.dim;
    ctx.lineWidth = 1;
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    ctx.moveTo(leftX, y);
    ctx.lineTo(rightX, y);
    ctx.stroke();
    ctx.setLineDash([]);

    ctx.fillStyle = COLORS.gold;
    ctx.font = '14px Space Mono';
    ctx.textAlign = 'center';
    ctx.fillText(STATE.separation + ' km separation', canvas.width / 2, y - 10);
    ctx.fillStyle = COLORS.dim;
    ctx.font = '11px Inter';
    ctx.fillText('(Entanglement works at ANY distance - even across the universe)', canvas.width / 2, y + 20);
}

// === START ===
init();
updateDisplays();
</script>

</body>
</html>
